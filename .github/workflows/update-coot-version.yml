name: Update Coot Version

# This workflow monitors the upstream Coot repository for new releases
# and automatically creates a PR to update the Flatpak manifest
#
# Setup Instructions:
# 1. To create PRs to flathub/io.github.pemsley.coot:
#    - Create a Personal Access Token (PAT) with 'repo' and 'workflow' scopes
#    - Add it as a secret named 'FLATHUB_PAT' in your repository settings
#    - The workflow will automatically create PRs to flathub
# 2. Without FLATHUB_PAT:
#    - PRs will be created in the current repository only
on:
  schedule:
    # Run daily at 00:00 UTC to check for new releases
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Coot release
        id: latest-release
        run: |
          # Fetch the latest release tag from pemsley/coot repository
          LATEST_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/pemsley/coot/releases/latest | \
            jq -r .tag_name)
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            echo "Error: Failed to fetch latest release"
            exit 1
          fi
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest upstream Coot version: $LATEST_TAG"

      - name: Get current version from manifest
        id: current-version
        run: |
          # Extract current tag from the manifest file
          if [ ! -f io.github.pemsley.coot.yaml ]; then
            echo "Error: Manifest file not found"
            exit 1
          fi
          
          CURRENT_TAG=$(grep -A2 "url: https://github.com/pemsley/coot.git" \
            io.github.pemsley.coot.yaml | grep "tag:" | awk '{print $2}')
          
          if [ -z "$CURRENT_TAG" ]; then
            echo "Error: Could not extract current tag from manifest"
            exit 1
          fi
          
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "Current version in manifest: $CURRENT_TAG"

      - name: Check if update is needed
        id: check-update
        run: |
          if [ "${{ steps.latest-release.outputs.latest_tag }}" != "${{ steps.current-version.outputs.current_tag }}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${{ steps.current-version.outputs.current_tag }} -> ${{ steps.latest-release.outputs.latest_tag }}"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Already up to date with ${{ steps.current-version.outputs.current_tag }}"
          fi

      - name: Update manifest file
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          # Update the tag in the manifest file
          sed -i "s/tag: ${{ steps.current-version.outputs.current_tag }}/tag: ${{ steps.latest-release.outputs.latest_tag }}/" io.github.pemsley.coot.yaml
          
          # Verify the update was successful
          if ! grep -q "tag: ${{ steps.latest-release.outputs.latest_tag }}" io.github.pemsley.coot.yaml; then
            echo "Error: Failed to update manifest file"
            exit 1
          fi
          
          echo "Updated manifest to version ${{ steps.latest-release.outputs.latest_tag }}"

      - name: Determine target repository
        if: steps.check-update.outputs.update_needed == 'true'
        id: target-repo
        run: |
          if [ -n "${{ secrets.FLATHUB_PAT }}" ]; then
            echo "repo=flathub/io.github.pemsley.coot" >> $GITHUB_OUTPUT
            echo "token_available=true" >> $GITHUB_OUTPUT
            echo "Target: flathub/io.github.pemsley.coot (with PAT)"
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "token_available=false" >> $GITHUB_OUTPUT
            echo "Target: ${{ github.repository }} (local repository)"
          fi

      - name: Create Pull Request to Flathub
        if: |
          steps.check-update.outputs.update_needed == 'true' &&
          steps.target-repo.outputs.token_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.FLATHUB_PAT }}
          push-to-fork: ${{ github.repository }}
          commit-message: "Update Coot to ${{ steps.latest-release.outputs.latest_tag }}"
          title: "Update Coot to ${{ steps.latest-release.outputs.latest_tag }}"
          body: |
            This PR updates Coot to ${{ steps.latest-release.outputs.latest_tag }}.

            **Changes:**
            - Update Coot from ${{ steps.current-version.outputs.current_tag }} to ${{ steps.latest-release.outputs.latest_tag }}

            **Upstream Release:**
            - https://github.com/pemsley/coot/releases/tag/${{ steps.latest-release.outputs.latest_tag }}

            This PR was automatically generated by the update-coot-version workflow.
          branch: update-coot-${{ steps.latest-release.outputs.latest_tag }}
          delete-branch: true
          labels: |
            automated
            version-update

      - name: Create Pull Request (Local)
        if: |
          steps.check-update.outputs.update_needed == 'true' &&
          steps.target-repo.outputs.token_available == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update Coot to ${{ steps.latest-release.outputs.latest_tag }}"
          title: "Update Coot to ${{ steps.latest-release.outputs.latest_tag }}"
          body: |
            This PR updates Coot to ${{ steps.latest-release.outputs.latest_tag }}.

            **Changes:**
            - Update Coot from ${{ steps.current-version.outputs.current_tag }} to ${{ steps.latest-release.outputs.latest_tag }}

            **Upstream Release:**
            - https://github.com/pemsley/coot/releases/tag/${{ steps.latest-release.outputs.latest_tag }}

            **Next Steps:**
            To submit this update to Flathub, you need to:
            1. Review and merge this PR
            2. Create a PR from this repository to flathub/io.github.pemsley.coot

            Or configure FLATHUB_PAT secret for automatic PR creation to Flathub.

            This PR was automatically generated by the update-coot-version workflow.
          branch: update-coot-${{ steps.latest-release.outputs.latest_tag }}
          delete-branch: true
          labels: |
            automated
            version-update

      - name: Output result
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          if [ "${{ steps.target-repo.outputs.token_available }}" == "true" ]; then
            echo "✅ Successfully created PR to flathub for Coot ${{ steps.latest-release.outputs.latest_tag }}"
          else
            echo "✅ Successfully created local PR for Coot ${{ steps.latest-release.outputs.latest_tag }}"
            echo "ℹ️  Configure FLATHUB_PAT secret to automatically create PRs to Flathub"
          fi
